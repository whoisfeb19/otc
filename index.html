<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTC MOD</title>
    <!-- PERBAIKAN: Link font & ikon yang benar agar tidak kena blokir CORB -->
    <link href="https://fonts.googleapis.com" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com">
    <style>
        :root { --accent: #00d2ff; --bg: #0b0e14; --card: #161b22; }
        body { 
            /* Ganti 'background.jpg' dengan nama file kamu (misal: bg.png atau wallpaper.jpg) */
            background: linear-gradient(rgba(11, 14, 20, 0.7), rgba(11, 14, 20, 0.7)), 
                        url('gta.png'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #fff; 
            font-family: 'Poppins', sans-serif; 
            margin: 0; 
    }

        header { text-align: center; padding: 60px 20px; border-bottom: 2px solid var(--accent); background: #000; }
        h1 { font-family: 'Orbitron'; font-size: 3rem; color: var(--accent); margin: 0; text-transform: uppercase; }
        .social-container { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .btn-social { padding: 12px 24px; border-radius: 50px; text-decoration: none; color: #fff; border: 2px solid rgba(255,255,255,0.3); transition: all 0.3s ease; font-size: 14px; display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .btn-yt { border-color: rgba(255,0,0,0.4); }
        .btn-yt:hover { background: linear-gradient(135deg, #ff0000, #cc0000); border-color: #ff0000; box-shadow: 0 0 20px #ff0000; transform: scale(1.05); }
        .btn-dc { border-color: rgba(114,137,218,0.4); }
        .btn-dc:hover { background: linear-gradient(135deg, #7289da, #5a73c8); border-color: #7289da; box-shadow: 0 0 20px #7289da; transform: scale(1.05); }
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .card { background: var(--card); border-radius: 15px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; }
        .card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .preview { width: 100%; height: 180px; background: #000; }
        .preview iframe, .preview img { width: 100%; height: 100%; border: none; object-fit: cover; }
        .content { padding: 20px; }
        .platform { background: var(--accent); color: #000; padding: 3px 10px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .price-tag { background: #ff6b00; color: #fff; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-left: 8px; }
        .price-free { background: #00b894; }
        .btn-dl { display: block; border: 2px solid var(--accent); color: var(--accent); text-align: center; padding: 10px; border-radius: 8px; text-decoration: none; font-weight: bold; margin-top: 15px; transition: 0.3s; cursor: pointer; }
        .btn-dl:hover { background: var(--accent); color: #000; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card); padding: 30px; border-radius: 15px; border: 2px solid var(--accent); width: 90%; max-width: 400px; }
        .modal-content h2 { color: var(--accent); margin-top: 0; }
        .modal-content input, .modal-content textarea { width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid #333; background: #0b0e14; color: #fff; box-sizing: border-box; }
        .modal-content button { width: 100%; padding: 12px; background: var(--accent); border: none; color: #000; font-weight: bold; border-radius: 8px; cursor: pointer; margin-top: 15px; }
        .modal-content button:hover { opacity: 0.8; }
        .close-modal { color: var(--accent); float: right; font-size: 28px; cursor: pointer; }
        .close-modal:hover { color: #fff; }
        .login-modal { z-index: 2000; }
        .login-modal .modal-content { text-align: center; }
        .login-modal h2 { font-size: 24px; margin-bottom: 15px; }
        .login-modal p { color: #aaa; margin: 15px 0; font-size: 16px; }
        .login-modal .btn-login { background: linear-gradient(135deg, #7289da, #5a73c8); border: none; padding: 15px 40px; font-size: 16px; margin-top: 20px; }
        .login-modal .btn-login:hover { opacity: 0.9; box-shadow: 0 0 20px #7289da; }
    </style>
</head>
<body>

<header>
    <h1>OTC MOD</h1>
    <div class="social-container">
        <a href="https://www.youtube.com/@CHANNEL_NAME" class="btn-social btn-yt" target="_blank"><i class="fab fa-youtube"></i> YouTube</a>
        <a href="https://discord.gg/QFutgE9DnU" class="btn-social btn-dc" target="_blank"><i class="fab fa-discord"></i> Discord</a>
    </div>
</header>

<div class="container">
    <div id="modGrid" class="grid">Memuat Database... ‚è≥</div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal login-modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeLoginModal()">&times;</span>
        <h2>üîê LOGIN DIPERLUKAN</h2>
        <p>Silahkan login dengan Discord untuk melanjutkan pembelian.</p>
        <p style="font-size: 14px; color: #888;">Anda akan diverifikasi sebagai member resmi kami.</p>
        <button class="btn-login" onclick="proceedToDiscordLogin()">üéÆ LOGIN DENGAN DISCORD</button>
    </div>
</div>

<!-- Modal Buy -->
<div id="buyModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeBuyModal()">&times;</span>
        <h2>üõí PURCHASE</h2>
        <input type="text" id="buyNama" placeholder="Nama Lengkap" required>
        <input type="text" id="buyDiscord" placeholder="Discord Username" readonly>
        <input type="text" id="buyFile" placeholder="File" readonly>
        <input type="text" id="buyHarga" placeholder="Harga" readonly>
        <textarea id="buyInfo" placeholder="Informasi tambahan (optional)" style="resize: none; height: 60px;"></textarea>
        <button onclick="sendToDiscord()">üí∞ KIRIM PEMBAYARAN</button>
    </div>
</div>

<script>
    // Link CSV Anda sudah benar, pastikan Spreadsheet-nya masih di-publish ke Web
    const csvURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQDRJ17ZZZahiwECXbmCf5xG6VgsbUZrIoI7gsRuFijxwe_d0iaytC3dT57O9qkR3lLP7xgmJfMA8S9/pub?gid=0&single=true&output=csv';

    // Gunakan process.env untuk mengambil data dari Netlify
const DISCORD_WEBHOOK = 'DISCORD_WEBHOOK_PLACEHOLDER';
const DISCORD_SERVER = 'https://discord.gg/QFutgE9DnU'; // Ini aman untuk di-hardcode
const DISCORD_CLIENT_ID = 'DISCORD_CLIENT_ID_PLACEHOLDER';
const DISCORD_REDIRECT_URI = 'https://otc-official.netlify.app';
const GUILD_ID = 'GUILD_ID_PLACEHOLDER';
const BOT_TOKEN = 'BOT_TOKEN_PLACEHOLDER';


    
    let currentUser = null;

    // Check if user sudah login (dari localStorage)
    function initAuth() {
        const saved = localStorage.getItem('otc_user');
        if (saved) {
            currentUser = JSON.parse(saved);
            updateLoginUI();
        } else {
            checkOAuthCallback();
        }
    }

    function checkOAuthCallback() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        
        if (code) {
            exchangeCodeForToken(code);
        }
    }

    async function exchangeCodeForToken(code) {
        try {
            const response = await fetch('https://discord.com/api/oauth2/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    client_id: DISCORD_CLIENT_ID,
                    client_secret: '2Y09IiL57dvUZj-72Dx9umPu-yDWGY76',
                    code: code,
                    grant_type: 'authorization_code',
                    redirect_uri: DISCORD_REDIRECT_URI,
                    scope: 'identify'
                })
            });

            if (!response.ok) {
                console.error('Token response error:', await response.text());
                return;
            }

            const data = await response.json();
            
            const userResponse = await fetch('https://discord.com/api/users/@me', {
                headers: { 'Authorization': `Bearer ${data.access_token}` }
            });

            if (!userResponse.ok) {
                console.error('User fetch error:', await userResponse.text());
                return;
            }

            const userData = await userResponse.json();
            
            // Simpan user data ke localStorage
            currentUser = { id: userData.id, username: userData.username, avatar: userData.avatar };
            localStorage.setItem('otc_user', JSON.stringify(currentUser));
            updateLoginUI();
            
            // Clear URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Jika ada pending buy, buka modal otomatis
            const pendingBuy = localStorage.getItem('otc_pending_buy');
            if (pendingBuy) {
                const { namaFile, harga } = JSON.parse(pendingBuy);
                localStorage.removeItem('otc_pending_buy');
                setTimeout(() => openBuyModal(namaFile, harga), 500);
            }
        } catch (e) {
            console.error('OAuth error:', e);
        }
    }

    function updateLoginUI() {
        // Login button removed - login happens on BUY click
    }

    function openBuyModal(namaFile, harga) {
        if (!currentUser) {
            // Simpan intent user dan show login modal
            localStorage.setItem('otc_pending_buy', JSON.stringify({ namaFile, harga }));
            document.getElementById('loginModal').classList.add('active');
            return;
        }
        
        document.getElementById('buyFile').value = namaFile;
        document.getElementById('buyHarga').value = harga;
        document.getElementById('buyNama').value = '';
        document.getElementById('buyDiscord').value = currentUser.username;
        document.getElementById('buyInfo').value = '';
        document.getElementById('buyModal').classList.add('active');
    }
    
    function closeLoginModal() {
        document.getElementById('loginModal').classList.remove('active');
    }
    
    function proceedToDiscordLogin() {
        closeLoginModal();
        window.location.href = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${DISCORD_REDIRECT_URI}&response_type=code&scope=identify%20guilds.join`;
    }

    function closeBuyModal() {
        document.getElementById('buyModal').classList.remove('active');
    }

    async function sendToDiscord() {
    const nama = document.getElementById('buyNama').value.trim();
    const file = document.getElementById('buyFile').value;
    const harga = document.getElementById('buyHarga').value;
    const info = document.getElementById('buyInfo').value;

    if (!nama) {
        alert('Isi Nama Lengkap!');
        return;
    }

    try {
        const embed = {
            title: 'üí∞ PURCHASE VERIFIED',
            description: `User baru ingin membeli: **${file}**`,
            color: 2969626,
            fields: [
                { name: 'üë§ Nama', value: nama, inline: true },
                { name: 'üéÆ Discord', value: `<@${currentUser.id}>`, inline: true },
                { name: 'üì¶ File', value: file, inline: false },
                { name: 'üíµ Harga', value: harga, inline: true },
                { name: '‚è∞ Waktu', value: new Date().toLocaleString('id-ID'), inline: false },
                { name: '‚úÖ Status', value: '**VERIFIED & JOINED**', inline: false },
                { name: 'üìù Info', value: info || 'Tidak ada', inline: false }
            ],
            footer: { text: 'OTC MOD HUB - USER SUDAH DI-SERVER' }
        };

        const response = await fetch(DISCORD_WEBHOOK, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ embeds: [embed] })
        });

        if (response.ok) {
            // Tampilkan notif success
            const userConfirmed = confirm('‚úÖ Pembayaran diterima!\n\nüìå User: ' + currentUser.username + '\n\nüíé Klik OK untuk bergabung ke Discord server');
            
            // Jika user klik OK, redirect ke Discord
            if (userConfirmed) {
                closeBuyModal();
                // Buka Discord server di tab baru atau sama
                window.location.href = DISCORD_SERVER;
            } else {
                closeBuyModal();
            }
        } else {
            alert('‚ùå Gagal mengirim. Coba lagi!');
        }
    } catch (e) {
        alert('‚ùå Error: ' + e.message);
    }
}

    // Fungsi untuk convert Google Drive link ke format download
    function convertDriveLink(url) {
        if (!url) return url;
        // Ekstrak file ID dari berbagai format Google Drive URL
        let fileId = "";
        if (url.includes('drive.google.com')) {
            const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (match) fileId = match[1];
        }
        // Return format download langsung jika file ID ditemukan
        return fileId ? `https://drive.google.com/uc?id=${fileId}&export=download` : url;
    }

    async function loadMods() {
        const grid = document.getElementById('modGrid');
        try {
            const r = await fetch(csvURL);
            if (!r.ok) throw new Error('Gagal fetch');
            const d = await r.text();
            const rows = d.split('\n').slice(1);
            grid.innerHTML = '';

            rows.forEach(row => {
                const col = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if(col.length < 5) return;

                const nama = col[0].replace(/"/g, "").trim();
                const desc = col[1].replace(/"/g, "").trim();
                const plat = col[2].replace(/"/g, "").trim();
                const prev = col[3].replace(/"/g, "").trim();
                let link = col[4].replace(/"/g, "").trim();
                const price = (col[5] ? col[5].replace(/"/g, "").trim() : "") || "Free";
                link = convertDriveLink(link);

                let media = '';
                // PERBAIKAN: Logika penentuan Video ID dan format link Embed
                if (prev.includes('youtube.com') || prev.includes('youtu.be')) {
                    let videoId = "";
                    if (prev.includes('v=')) {
                        videoId = prev.split('v=')[1].split('&')[0];
                    } else {
                        videoId = prev.split('/').pop().split('?')[0];
                    }
                    media = `<iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>`;
                } else {
                    media = `<img src="${prev}" onerror="this.src='https://placehold.co'">`;
                }

                // Buat price tag
                const priceClass = price === 'Free' ? 'price-free' : '';
                const priceText = price === 'Free' ? 'üéÅ FREE' : 'üí∞ ' + price;

                // Menggunakan backtick ( ` ) untuk membungkus HTML
                grid.innerHTML += `
                <div class="card">
                    <div class="preview">${media}</div>
                    <div class="content">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <span class="platform">${plat}</span>
                            <span class="price-tag ${priceClass}">${priceText}</span>
                        </div>
                        <h3 style="margin:10px 0 5px; font-size:18px;">${nama}</h3>
                        <p style="font-size:13px; color:#aaa; margin-bottom:15px; height:40px; overflow:hidden;">${desc}</p>
                        ${price === 'Free' ? `<a href="${link}" class="btn-dl" download target="_blank">‚¨áÔ∏è DOWNLOAD</a>` : `<button class="btn-dl" onclick="openBuyModal('${nama}', '${price}')">üõí BUY</button>`}
                    </div>
                </div>`;
            });
            if(grid.innerHTML === "") grid.innerHTML = "Database kosong.";
        } catch(e) {
            grid.innerHTML = "Gagal memuat data. Pastikan link Google Sheets sudah di-'Publish to the web'.";
            console.error(e);
        }
    }
    loadMods();
    initAuth(); // Initialize authentication - harus di akhir setelah semua function terdefinisi
</script>
</body>
</html>
